# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

UIGen is an AI-powered React component generator with live preview. It allows users to describe React components in natural language, which are then generated by an AI (Claude) and displayed in real-time. The application uses a virtual file system (VFS) that stores generated components in memory without writing to disk.

## Development Commands

### Setup
```bash
npm run setup          # Install dependencies, generate Prisma client, run migrations
```

### Development
```bash
npm run dev            # Start Next.js dev server with Turbopack
npm run dev:daemon     # Start dev server in background, logs to logs.txt
```

### Testing
```bash
npm test               # Run Vitest tests
```

### Build & Production
```bash
npm run build          # Build for production
npm start              # Start production server
npm run lint           # Run ESLint
```

### Database
```bash
npx prisma generate    # Generate Prisma client (outputs to src/generated/prisma)
npx prisma migrate dev # Create and apply migrations
npm run db:reset       # Reset database (WARNING: destructive)
```

## Architecture

### Virtual File System (VFS)

The core architecture centers around a **VirtualFileSystem** class (`src/lib/file-system.ts`) that maintains an in-memory file tree. This is the foundation of the entire component generation system:

- Files are stored as a tree structure with `FileNode` objects
- Each node can be a file (with content) or directory (with children)
- The VFS is serialized to JSON and stored in the database for registered users
- On the client side, the VFS is maintained in React state via `FileSystemContext`
- The AI interacts with the VFS using two tools: `str_replace_editor` and `file_manager`

### AI Component Generation Flow

1. **User Input**: User types a component description in the chat interface
2. **API Route** (`src/app/api/chat/route.ts`): Handles the AI interaction
   - Receives messages and current VFS state from client
   - Reconstructs VFS from serialized data
   - Calls Vercel AI SDK's `streamText` with two tools
   - Streams responses back to client
   - Saves final state to database for authenticated users
3. **AI Tools**:
   - `str_replace_editor` (`src/lib/tools/str-replace.ts`): Create, view, and edit files using string replacement
   - `file_manager` (`src/lib/tools/file-manager.ts`): Rename and delete files/directories
4. **Live Preview** (`src/components/preview/PreviewFrame.tsx`):
   - Watches for VFS changes via React context
   - Transforms all JSX/TSX files using Babel (`src/lib/transform/jsx-transformer.ts`)
   - Creates ES Module Import Map with blob URLs for each transformed file
   - Generates HTML with import map and renders in sandboxed iframe
   - Automatically finds entry point (App.jsx/tsx or index.jsx/tsx)

### Mock Provider for Development

The system includes a `MockLanguageModel` (`src/lib/provider.ts`) that allows development without an Anthropic API key. It generates pre-defined components (Counter, Form, Card) with simulated streaming behavior.

### Database Schema

Uses Prisma with SQLite:
- **User**: Email/password authentication
- **Project**: Stores serialized messages and VFS state for each user project
- Prisma client is generated to `src/generated/prisma` (not standard location)

### Authentication

Simple JWT-based auth (`src/lib/auth.ts`):
- Anonymous users can use the app but can't save projects
- Registered users get persistent projects saved to database
- Middleware (`src/middleware.ts`) protects certain routes

### Component Structure

- `src/components/chat/`: Chat interface (MessageList, MessageInput, MarkdownRenderer)
- `src/components/editor/`: Code editor using Monaco (CodeEditor, FileTree)
- `src/components/preview/`: Live preview frame with Babel transformation
- `src/components/auth/`: Sign in/up forms with dialog
- `src/actions/`: Server actions for project CRUD operations

### Key Technical Decisions

1. **Virtual File System**: No files are written to disk. Everything exists in memory and database.
2. **Client-side Transpilation**: JSX/TSX is transformed in the browser using `@babel/standalone`
3. **Import Maps**: Modern browser feature used to map module specifiers to blob URLs
4. **Sandboxed Preview**: iframe with `allow-scripts allow-same-origin allow-forms` for security
5. **Stream-based AI**: Uses Vercel AI SDK's streaming for real-time response rendering
6. **Entry Point Convention**: Always requires `/App.jsx` as the root component

## Important Conventions

### Code Style

- Use comments sparingly. Only comment complex code that isn't self-evident

### File Imports in Generated Code

The AI is instructed (via `src/lib/prompts/generation.tsx`) to:
- Use `@/` alias for all non-library imports (e.g., `import Foo from '@/components/Foo'`)
- Always create `/App.jsx` as the entry point
- Use Tailwind CSS for styling, not inline styles
- Never create HTML files

### Database

The database schema is defined in `prisma/schema.prisma`. Reference it anytime you need to understand the structure of data stored in the database.

### Testing

Tests use Vitest with jsdom environment (`vitest.config.mts`). Tests are located in `__tests__` subdirectories within component folders.

### Prisma Output Location

The Prisma client is generated to `src/generated/prisma` instead of the default `node_modules/.prisma/client`. Import from `@/lib/prisma`.
